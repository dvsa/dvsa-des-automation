"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _iosCrashLog = require("../device-log/ios-crash-log");

var _iosSimulatorLog = require("../device-log/ios-simulator-log");

var _iosDeviceLog = require("../device-log/ios-device-log");

var _logger = _interopRequireDefault(require("../logger"));

var _ws = _interopRequireDefault(require("ws"));

var _safariConsoleLog = _interopRequireDefault(require("../device-log/safari-console-log"));

var _safariNetworkLog = _interopRequireDefault(require("../device-log/safari-network-log"));

const extensions = {};

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/syslog`;

const GET_SERVER_LOGS_FEATURE = 'get_server_logs';

extensions.extractLogs = async function extractLogs(logType, logsContainer = {}) {
  if (_lodash.default.isEmpty(logsContainer)) {
    throw new Error('No logs currently available. Is the device/simulator started?');
  }

  const logObject = logsContainer[logType];
  const logs = logObject ? await logObject.getLogs() : null;

  if (logs) {
    return logs;
  }

  throw new Error(`No logs of type '${logType}' found.`);
};

extensions.supportedLogTypes = {
  syslog: {
    description: 'System Logs - Device logs for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('syslog', self.logs)
  },
  crashlog: {
    description: 'Crash Logs - Crash reports for iOS applications on real devices and simulators',
    getter: async self => await self.extractLogs('crashlog', self.logs)
  },
  performance: {
    description: 'Performance Logs - Debug Timelines on real devices and simulators',
    getter: async self => await self.extractLogs('performance', self.logs)
  },
  safariConsole: {
    description: 'Safari Console Logs - data written to the JS console in Safari',
    getter: async self => await self.extractLogs('safariConsole', self.logs)
  },
  safariNetwork: {
    description: 'Safari Network Logs - information about network operations undertaken by Safari',
    getter: async self => await self.extractLogs('safariNetwork', self.logs)
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      self.ensureFeatureEnabled(GET_SERVER_LOGS_FEATURE);
      return _logger.default.unwrap().record.map(function (x) {
        return {
          timestamp: Date.now(),
          level: 'ALL',
          message: _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`
        };
      });
    }
  }
};

extensions.startLogCapture = async function startLogCapture() {
  this.logs = this.logs || {};

  if (!_lodash.default.isUndefined(this.logs.syslog) && this.logs.syslog.isCapturing) {
    _logger.default.warn('Trying to start iOS log capture but it has already started!');

    return true;
  }

  if (_lodash.default.isUndefined(this.logs.syslog)) {
    this.logs.crashlog = new _iosCrashLog.IOSCrashLog({
      sim: this.opts.device,
      udid: this.isRealDevice() ? this.opts.udid : undefined
    });

    if (this.isRealDevice()) {
      this.logs.syslog = new _iosDeviceLog.IOSDeviceLog({
        udid: this.opts.udid,
        showLogs: this.opts.showIOSLog
      });
    } else {
      this.logs.syslog = new _iosSimulatorLog.IOSSimulatorLog({
        sim: this.opts.device,
        showLogs: this.opts.showIOSLog,
        xcodeVersion: this.xcodeVersion,
        iosSimulatorLogsPredicate: this.opts.iosSimulatorLogsPredicate
      });
    }

    this.logs.safariConsole = new _safariConsoleLog.default(!!this.opts.showSafariConsoleLog);
    this.logs.safariNetwork = new _safariNetworkLog.default(!!this.opts.showSafariNetworkLog);
  }

  try {
    await this.logs.syslog.startCapture();
  } catch (err) {
    _logger.default.warn(`Continuing without capturing device logs: ${err.message}`);

    return false;
  }

  await this.logs.crashlog.startCapture();
  await this.logs.safariConsole.startCapture();
  await this.logs.safariNetwork.startCapture();
  return true;
};

extensions.mobileStartLogsBroadcast = async function mobileStartLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    _logger.default.debug(`The system logs broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning system logs broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new system logs listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new system logs listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._syslogWebsocketListener)) {
      this._syslogWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.logs.syslog.on('output', this._syslogWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._syslogWebsocketListener)) {
        this.logs.syslog.removeListener('output', this._syslogWebsocketListener);
        this._syslogWebsocketListener = null;
      }

      let closeMsg = 'System logs listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

extensions.mobileStopLogsBroadcast = async function mobileStopLogsBroadcast() {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty(await this.server.getWebSocketHandlers(pathname))) {
    return;
  }

  _logger.default.debug('Stopping the system logs broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwiR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUiLCJleHRyYWN0TG9ncyIsImxvZ1R5cGUiLCJsb2dzQ29udGFpbmVyIiwiXyIsImlzRW1wdHkiLCJFcnJvciIsImxvZ09iamVjdCIsImxvZ3MiLCJnZXRMb2dzIiwic3VwcG9ydGVkTG9nVHlwZXMiLCJzeXNsb2ciLCJkZXNjcmlwdGlvbiIsImdldHRlciIsInNlbGYiLCJjcmFzaGxvZyIsInBlcmZvcm1hbmNlIiwic2FmYXJpQ29uc29sZSIsInNhZmFyaU5ldHdvcmsiLCJzZXJ2ZXIiLCJlbnN1cmVGZWF0dXJlRW5hYmxlZCIsImxvZyIsInVud3JhcCIsInJlY29yZCIsIm1hcCIsIngiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwibGV2ZWwiLCJtZXNzYWdlIiwicHJlZml4Iiwic3RhcnRMb2dDYXB0dXJlIiwiaXNVbmRlZmluZWQiLCJpc0NhcHR1cmluZyIsIndhcm4iLCJJT1NDcmFzaExvZyIsInNpbSIsIm9wdHMiLCJkZXZpY2UiLCJ1ZGlkIiwiaXNSZWFsRGV2aWNlIiwidW5kZWZpbmVkIiwiSU9TRGV2aWNlTG9nIiwic2hvd0xvZ3MiLCJzaG93SU9TTG9nIiwiSU9TU2ltdWxhdG9yTG9nIiwieGNvZGVWZXJzaW9uIiwiaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSIsIlNhZmFyaUNvbnNvbGVMb2ciLCJzaG93U2FmYXJpQ29uc29sZUxvZyIsIlNhZmFyaU5ldHdvcmtMb2ciLCJzaG93U2FmYXJpTmV0d29ya0xvZyIsInN0YXJ0Q2FwdHVyZSIsImVyciIsIm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCIsInBhdGhuYW1lIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsImNvZGUiLCJyZWFzb24iLCJyZW1vdmVMaXN0ZW5lciIsImNsb3NlTXNnIiwiYWRkV2ViU29ja2V0SGFuZGxlciIsIm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0IiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxVQUFVLEdBQUcsRUFBbkI7O0FBRUEsTUFBTUMsa0JBQWtCLEdBQUlDLFNBQUQsSUFBZ0IsR0FBRUMsNENBQTJCLFlBQVdELFNBQVUsdUJBQTdGOztBQUNBLE1BQU1FLHVCQUF1QixHQUFHLGlCQUFoQzs7QUFFQUosVUFBVSxDQUFDSyxXQUFYLEdBQXlCLGVBQWVBLFdBQWYsQ0FBNEJDLE9BQTVCLEVBQXFDQyxhQUFhLEdBQUcsRUFBckQsRUFBeUQ7QUFHaEYsTUFBSUMsZ0JBQUVDLE9BQUYsQ0FBVUYsYUFBVixDQUFKLEVBQThCO0FBQzVCLFVBQU0sSUFBSUcsS0FBSixDQUFVLCtEQUFWLENBQU47QUFDRDs7QUFHRCxRQUFNQyxTQUFTLEdBQUdKLGFBQWEsQ0FBQ0QsT0FBRCxDQUEvQjtBQUNBLFFBQU1NLElBQUksR0FBR0QsU0FBUyxHQUFHLE1BQU1BLFNBQVMsQ0FBQ0UsT0FBVixFQUFULEdBQStCLElBQXJEOztBQUNBLE1BQUlELElBQUosRUFBVTtBQUNSLFdBQU9BLElBQVA7QUFDRDs7QUFDRCxRQUFNLElBQUlGLEtBQUosQ0FBVyxvQkFBbUJKLE9BQVEsVUFBdEMsQ0FBTjtBQUNELENBZEQ7O0FBZ0JBTixVQUFVLENBQUNjLGlCQUFYLEdBQStCO0FB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QUFGLENBQVUsTUFBTSxLQUFLYyxNQUFMLENBQVlzQyxvQkFBWixDQUFpQ0QsUUFBakMsQ0FBaEIsQ0FBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEbkMsa0JBQUlxQyxLQUFKLENBQVUseURBQVY7O0FBQ0EsUUFBTSxLQUFLdkMsTUFBTCxDQUFZK0Qsc0JBQVosQ0FBbUMxQixRQUFuQyxDQUFOO0FBQ0QsQ0FSRDs7ZUFXZTVELFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgSU9TQ3Jhc2hMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1jcmFzaC1sb2cnO1xuaW1wb3J0IHsgSU9TU2ltdWxhdG9yTG9nIH0gZnJvbSAnLi4vZGV2aWNlLWxvZy9pb3Mtc2ltdWxhdG9yLWxvZyc7XG5pbXBvcnQgeyBJT1NEZXZpY2VMb2cgfSBmcm9tICcuLi9kZXZpY2UtbG9nL2lvcy1kZXZpY2UtbG9nJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IFNhZmFyaUNvbnNvbGVMb2cgZnJvbSAnLi4vZGV2aWNlLWxvZy9zYWZhcmktY29uc29sZS1sb2cnO1xuaW1wb3J0IFNhZmFyaU5ldHdvcmtMb2cgZnJvbSAnLi4vZGV2aWNlLWxvZy9zYWZhcmktbmV0d29yay1sb2cnO1xuXG5cbmNvbnN0IGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0VCU09DS0VUX0VORFBPSU5UID0gKHNlc3Npb25JZCkgPT4gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L3Nlc3Npb24vJHtzZXNzaW9uSWR9L2FwcGl1bS9kZXZpY2Uvc3lzbG9nYDtcbmNvbnN0IEdFVF9TRVJWRVJfTE9HU19GRUFUVVJFID0gJ2dldF9zZXJ2ZXJfbG9ncyc7XG5cbmV4dGVuc2lvbnMuZXh0cmFjdExvZ3MgPSBhc3luYyBmdW5jdGlvbiBleHRyYWN0TG9ncyAobG9nVHlwZSwgbG9nc0NvbnRhaW5lciA9IHt9KSB7XG4gIC8vIG1ha2Ugc3VyZSB0aGF0IHdlIGhhdmUgbG9ncyBhdCBhbGxcbiAgLy8gb3RoZXJ3aXNlIGl0J3Mgbm90IGJlZW4gaW5pdGlhbGl6ZWRcbiAgaWYgKF8uaXNFbXB0eShsb2dzQ29udGFpbmVyKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignTm8gbG9ncyBjdXJyZW50bHkgYXZhaWxhYmxlLiBJcyB0aGUgZGV2aWNlL3NpbXVsYXRvciBzdGFydGVkPycpO1xuICB9XG5cbiAgLy8gSWYgbG9ncyBjYXB0dXJlZCBzdWNjZXNzZnVsbHkgc2VuZCByZXNwb25zZSB3aXRoIGRhdGEsIGVsc2Ugc2VuZCBlcnJvclxuICBjb25zdCBsb2dPYmplY3QgPSBsb2dzQ29udGFpbmVyW2xvZ1R5cGVdO1xuICBjb25zdCBsb2dzID0gbG9nT2JqZWN0ID8gYXdhaXQgbG9nT2JqZWN0LmdldExvZ3MoKSA6IG51bGw7XG4gIGlmIChsb2dzKSB7XG4gICAgcmV0dXJuIGxvZ3M7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBObyBsb2dzIG9mIHR5cGUgJyR7bG9nVHlwZX0nIGZvdW5kLmApO1xufTtcblxuZXh0ZW5zaW9ucy5zdXBwb3J0ZWRMb2dUeXBlcyA9IHtcbiAgc3lzbG9nOiB7XG4gICAgZGVzY3JpcHRpb246ICdTeXN0ZW0gTG9ncyAtIERldmljZSBsb2dzIGZvciBpT1MgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycycsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnc3lzbG9nJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgY3Jhc2hsb2c6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0NyYXNoIExvZ3MgLSBDcmFzaCByZXBvcnRzIGZvciBpT1MgYXBwbGljYXRpb25zIG9uIHJlYWwgZGV2aWNlcyBhbmQgc2ltdWxhdG9ycycsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4gYXdhaXQgc2VsZi5leHRyYWN0TG9ncygnY3Jhc2hsb2cnLCBzZWxmLmxvZ3MpLFxuICB9LFxuICBwZXJmb3JtYW5jZToge1xuICAgIGRlc2NyaXB0aW9uOiAnUGVyZm9ybWFuY2UgTG9ncyAtIERlYnVnIFRpbWVsaW5lcyBvbiByZWFsIGRldmljZXMgYW5kIHNpbXVsYXRvcnMnLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3BlcmZvcm1hbmNlJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgc2FmYXJpQ29uc29sZToge1xuICAgIGRlc2NyaXB0aW9uOiAnU2FmYXJpIENvbnNvbGUgTG9ncyAtIGRhdGEgd3JpdHRlbiB0byB0aGUgSlMgY29uc29sZSBpbiBTYWZhcmknLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuZXh0cmFjdExvZ3MoJ3NhZmFyaUNvbnNvbGUnLCBzZWxmLmxvZ3MpLFxuICB9LFxuICBzYWZhcmlOZXR3b3JrOiB7XG4gICAgZGVzY3JpcHRpb246ICdTYWZhcmkgTmV0d29yayBMb2dzIC0gaW5mb3JtYXRpb24gYWJvdXQgbmV0d29yayBvcGVyYXRpb25zIHVuZGVydGFrZW4gYnkgU2FmYXJpJyxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmV4dHJhY3RMb2dzKCdzYWZhcmlOZXR3b3JrJywgc2VsZi5sb2dzKSxcbiAgfSxcbiAgc2VydmVyOiB7XG4gICAgZGVzY3JpcHRpb246ICdBcHBpdW0gc2VydmVyIGxvZ3MnLFxuICAgIGdldHRlcjogKHNlbGYpID0+IHtcbiAgICAgIHNlbGYuZW5zdXJlRmVhdHVyZUVuYWJsZWQoR0VUX1NFUlZFUl9MT0dTX0ZFQVRVUkUpO1xuICAgICAgcmV0dXJuIGxvZy51bndyYXAoKS5yZWNvcmRcbiAgICAgICAgLm1hcChmdW5jdGlvbiAoeCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAvLyBucG1sb2cgZG9lcyBub3Qga2VlcCB0aW1lc3RhbXBzIGluIHRoZSBoaXN0b3J5XG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICBsZXZlbDogJ0FMTCcsXG4gICAgICAgICAgICBtZXNzYWdlOiBfLmlzRW1wdHkoeC5wcmVmaXgpID8geC5tZXNzYWdlIDogYFske3gucHJlZml4fV0gJHt4Lm1lc3NhZ2V9YCxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9LFxuICB9LFxufTtcblxuZXh0ZW5zaW9ucy5zdGFydExvZ0NhcHR1cmUgPSBhc3luYyBmdW5jdGlvbiBzdGFydExvZ0NhcHR1cmUgKCkge1xuICB0aGlzLmxvZ3MgPSB0aGlzLmxvZ3MgfHwge307XG4gIGlmICghXy5pc1VuZGVmaW5lZCh0aGlzLmxvZ3Muc3lzbG9nKSAmJiB0aGlzLmxvZ3Muc3lzbG9nLmlzQ2FwdHVyaW5nKSB7XG4gICAgbG9nLndhcm4oJ1RyeWluZyB0byBzdGFydCBpT1MgbG9nIGNhcHR1cmUgYnV0IGl0IGhhcyBhbHJlYWR5IHN0YXJ0ZWQhJyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5sb2dzLnN5c2xvZykpIHtcbiAgICB0aGlzLmxvZ3MuY3Jhc2hsb2cgPSBuZXcgSU9TQ3Jhc2hMb2coe1xuICAgICAgc2ltOiB0aGlzLm9wdHMuZGV2aWNlLFxuICAgICAgdWRpZDogdGhpcy5pc1JlYWxEZXZpY2UoKSA/IHRoaXMub3B0cy51ZGlkIDogdW5kZWZpbmVkLFxuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMubG9ncy5zeXNsb2cgPSBuZXcgSU9TRGV2aWNlTG9nKHtcbiAgICAgICAgdWRpZDogdGhpcy5vcHRzLnVkaWQsXG4gICAgICAgIHNob3dMb2dzOiB0aGlzLm9wdHMuc2hvd0lPU0xvZyxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvZ3Muc3lzbG9nID0gbmV3IElPU1NpbXVsYXRvckxvZyh7XG4gICAgICAgIHNpbTogdGhpcy5vcHRzLmRldmljZSxcbiAgICAgICAgc2hvd0xvZ3M6IHRoaXMub3B0cy5zaG93SU9TTG9nLFxuICAgICAgICB4Y29kZVZlcnNpb246IHRoaXMueGNvZGVWZXJzaW9uLFxuICAgICAgICBpb3NTaW11bGF0b3JMb2dzUHJlZGljYXRlOiB0aGlzLm9wdHMuaW9zU2ltdWxhdG9yTG9nc1ByZWRpY2F0ZSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSA9IG5ldyBTYWZhcmlDb25zb2xlTG9nKCEhdGhpcy5vcHRzLnNob3dTYWZhcmlDb25zb2xlTG9nKTtcbiAgICB0aGlzLmxvZ3Muc2FmYXJpTmV0d29yayA9IG5ldyBTYWZhcmlOZXR3b3JrTG9nKCEhdGhpcy5vcHRzLnNob3dTYWZhcmlOZXR3b3JrTG9nKTtcbiAgfVxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMubG9ncy5zeXNsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDb250aW51aW5nIHdpdGhvdXQgY2FwdHVyaW5nIGRldmljZSBsb2dzOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBhd2FpdCB0aGlzLmxvZ3MuY3Jhc2hsb2cuc3RhcnRDYXB0dXJlKCk7XG4gIGF3YWl0IHRoaXMubG9ncy5zYWZhcmlDb25zb2xlLnN0YXJ0Q2FwdHVyZSgpO1xuICBhd2FpdCB0aGlzLmxvZ3Muc2FmYXJpTmV0d29yay5zdGFydENhcHR1cmUoKTtcblxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8qKlxuICogU3RhcnRzIGlPUyBzeXN0ZW0gbG9ncyBicm9hZGNhc3Qgd2Vic29ja2V0IG9uIHRoZSBzYW1lIGhvc3QgYW5kIHBvcnRcbiAqIHdoZXJlIEFwcGl1bSBzZXJ2ZXIgaXMgcnVubmluZyBhdCBgL3dzL3Nlc3Npb24vOnNlc3Npb25JZDovYXBwaXVtL3N5c2xvZ2AgZW5kcG9pbnQuIFRoZSBtZXRob2RcbiAqIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIHRoZSB3ZWIgc29ja2V0IGlzIGFscmVhZHkgbGlzdGVuaW5nLlxuICpcbiAqIEVhY2ggY29ubmVjdGVkIHdlYmNva2V0IGxpc3RlbmVyIHdpbGwgcmVjZWl2ZSBzeXNsb2cgbGluZXNcbiAqIGFzIHNvb24gYXMgdGhleSBhcmUgdmlzaWJsZSB0byBBcHBpdW0uXG4gKi9cbmV4dGVuc2lvbnMubW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RhcnRMb2dzQnJvYWRjYXN0ICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoIV8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgbG9nLmRlYnVnKGBUaGUgc3lzdGVtIGxvZ3MgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyIGlzIGFscmVhZHkgbGlzdGVuaW5nIGF0ICR7cGF0aG5hbWV9YCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmluZm8oYEFzc2lnbmluZyBzeXN0ZW0gbG9ncyBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXIgdG8gJHtwYXRobmFtZX1gKTtcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYnNvY2tldHMvd3MvYmxvYi9tYXN0ZXIvZG9jL3dzLm1kXG4gIGNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHtcbiAgICBub1NlcnZlcjogdHJ1ZSxcbiAgfSk7XG4gIHdzcy5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgaWYgKHJlcSkge1xuICAgICAgY29uc3QgcmVtb3RlSXAgPSBfLmlzRW1wdHkocmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddKVxuICAgICAgICA/IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3NcbiAgICAgICAgOiByZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ107XG4gICAgICBsb2cuZGVidWcoYEVzdGFibGlzaGVkIGEgbmV3IHN5c3RlbSBsb2dzIGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBmcm9tICR7cmVtb3RlSXB9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRXN0YWJsaXNoZWQgYSBuZXcgc3lzdGVtIGxvZ3MgbGlzdGVuZXIgd2ViIHNvY2tldCBjb25uZWN0aW9uJyk7XG4gICAgfVxuXG4gICAgaWYgKF8uaXNFbXB0eSh0aGlzLl9zeXNsb2dXZWJzb2NrZXRMaXN0ZW5lcikpIHtcbiAgICAgIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyID0gKGxvZ1JlY29yZCkgPT4ge1xuICAgICAgICBpZiAod3MgJiYgd3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgICB3cy5zZW5kKGxvZ1JlY29yZC5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy5sb2dzLnN5c2xvZy5vbignb3V0cHV0JywgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpO1xuXG4gICAgd3Mub24oJ2Nsb3NlJywgKGNvZGUsIHJlYXNvbikgPT4ge1xuICAgICAgaWYgKCFfLmlzRW1wdHkodGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICAgIHRoaXMubG9ncy5zeXNsb2cucmVtb3ZlTGlzdGVuZXIoJ291dHB1dCcsIHRoaXMuX3N5c2xvZ1dlYnNvY2tldExpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5fc3lzbG9nV2Vic29ja2V0TGlzdGVuZXIgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICBsZXQgY2xvc2VNc2cgPSAnU3lzdGVtIGxvZ3MgbGlzdGVuZXIgd2ViIHNvY2tldCBpcyBjbG9zZWQuJztcbiAgICAgIGlmICghXy5pc0VtcHR5KGNvZGUpKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgQ29kZTogJHtjb2RlfS5gO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmlzRW1wdHkocmVhc29uKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIFJlYXNvbjogJHtyZWFzb259LmA7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoY2xvc2VNc2cpO1xuICAgIH0pO1xuICB9KTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIuYWRkV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSwgd3NzKTtcbn07XG5cbi8qKlxuICogU3RvcHMgdGhlIHByZXZpb3VzbHkgc3RhcnRlZCBzeXNsb2cgYnJvYWRjYXN0aW5nIHdlc29ja2V0IHNlcnZlci5cbiAqIFRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIG5vIHNlcnZlciBpcyBydW5uaW5nLlxuICovXG5leHRlbnNpb25zLm1vYmlsZVN0b3BMb2dzQnJvYWRjYXN0ID0gYXN5bmMgZnVuY3Rpb24gbW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgKCkge1xuICBjb25zdCBwYXRobmFtZSA9IFdFQlNPQ0tFVF9FTkRQT0lOVCh0aGlzLnNlc3Npb25JZCk7XG4gIGlmIChfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU3RvcHBpbmcgdGhlIHN5c3RlbSBsb2dzIGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlcicpO1xuICBhd2FpdCB0aGlzLnNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbn07XG5cblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2xvZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
